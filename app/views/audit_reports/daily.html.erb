<% html_title(l(:label_audit_daily_report)) -%>

<div class="contextual">
  <%= link_to "Export CSV", daily_project_audit_reports_path(@project, format: :csv, start_date: params[:start_date], end_date: params[:end_date]), class: "icon icon-download" %>
  <%= link_to "Back to Reports", project_audit_reports_path(@project), class: "icon icon-cancel" %>
</div>

<h2>Daily Report</h2>

<%= form_tag(daily_project_audit_reports_path(@project), method: :get, id: "date-filter-form") do %>
  <fieldset class="box tabular">
    <legend>Query Period</legend>

    <p class="mode-selector">
      <label class="mode-label">Mode</label>
      <span class="mode-options">
        <label class="mode-option floating">
          <%= radio_button_tag :mode, "range", params[:mode] != "day", id: "mode-range" %>
          Date Range
        </label>
        <label class="mode-option floating">
          <%= radio_button_tag :mode, "day", params[:mode] == "day", id: "mode-day" %>
          Single Day
        </label>
      </span>
    </p>

    <div id="range-mode-fields" style="<%= 'display: none;' if params[:mode] == 'day' %>">
      <p>
        <%= label_tag :start_date, "Start Date" %>
        <%= date_field_tag :start_date, @from_date.strftime('%Y-%m-%d'),
            min: 7.days.ago.to_date.strftime('%Y-%m-%d'),
            max: 1.day.from_now.to_date.strftime('%Y-%m-%d'),
            class: "date-picker auto-submit" %>
      </p>
      <p>
        <%= label_tag :end_date, "End Date" %>
        <%= date_field_tag :end_date, @to_date.strftime('%Y-%m-%d'),
            min: 7.days.ago.to_date.strftime('%Y-%m-%d'),
            max: 1.day.from_now.to_date.strftime('%Y-%m-%d'),
            class: "date-picker auto-submit" %>
      </p>
      <p>
        <label></label>
        <button type="button" id="full-week-btn" class="button-small">
          Set to Full Week
        </button>
      </p>
    </div>

    <div id="day-mode-fields" style="<%= 'display: none;' if params[:mode] != 'day' %>">
      <p>
        <%= label_tag :end_date, "Select Date" %>
        <%= date_field_tag :end_date,
            params[:end_date] || (@to_date.to_date if params[:mode] == 'day'),
            min: 7.days.ago.to_date,
            max: 1.day.from_now.to_date,
            class: "date-picker auto-submit" %>
        <span class="info-text">(Midnight to midnight)</span>
      </p>
      <p>
        <label></label>
        <button type="button" id="prev-day-btn" class="button-small">
          ← Previous Day
        </button>
        <button type="button" id="next-day-btn" class="button-small">
          Next Day →
        </button>
      </p>
    </div>

    <p>
      <label></label>
      <%= link_to "Reset to Default", daily_project_audit_reports_path(@project), class: "button-small" %>
    </p>
  </fieldset>
<% end %>

<% if @report_data.nil? || @report_data.empty? %>
  <p class="nodata">No employee status changes found for the query period.</p>
<% else %>
  <p class="report-info">
    Showing <%= pluralize(@report_data.size, 'employee') %> with status changes.
    <br>
    Query period: <%= @from_date.strftime('%Y-%m-%d') %> to <%= @to_date.strftime('%Y-%m-%d') %>
  </p>

  <table class="list issues <%= sort_css_classes %>">
    <thead>
      <tr>
        <%= sort_header_tag('employee_name', caption: 'Employee Name') %>
        <th>Current Status</th>
        <th>Open Tickets</th>
        <%= sort_header_tag('transaction_codes', caption: 'Transaction Codes') %>
        <th>Phone Number</th>
        <%= sort_header_tag('office', caption: 'Office') %>
        <%= sort_header_tag('office_location', caption: 'Office Location') %>
        <%= sort_header_tag('employee_id', caption: 'Employee ID') %>
        <%= sort_header_tag('post_date', caption: 'Post Date', default_order: 'asc') %>
      </tr>
    </thead>
    <tbody>
      <% @report_data.each do |row| %>
        <tr>
          <td>
            <%
              employee_id_field_id = NysenateAuditUtils::CustomFieldConfiguration.employee_id_field_id
              filter_url = project_issues_path(@project,
                set_filter: 1,
                "f[]": ["cf_#{employee_id_field_id}", "status_id"],
                "op[cf_#{employee_id_field_id}]": "=",
                "v[cf_#{employee_id_field_id}][]": row[:employee_id],
                "op[status_id]": "*"
              )
              # Fix the double array encoding in the URL
              filter_url = filter_url.gsub('f%5B%5D%5B%5D=', 'f%5B%5D=')
            %>
            <%= link_to row[:employee_name], filter_url, target: '_blank' %>
          </td>
          <td>
            <% if row[:account_statuses].present? %>
              <%= row[:account_statuses].map { |status|
                if status[:request_code].present?
                  link_to status[:request_code], issue_path(status[:issue_id]), target: '_blank'
                else
                  "#{status[:account_type]} (no code)"
                end
              }.join(', ').html_safe %>
            <% else %>
              <span class="no-data">—</span>
            <% end %>
          </td>
          <td>
            <% if row[:open_requests].present? %>
              <%= row[:open_requests].map { |request|
                if request[:request_code].present?
                  link_to request[:request_code], issue_path(request[:issue_id]), target: '_blank'
                else
                  "#{request[:account_type]} (no code)"
                end
              }.join(', ').html_safe %>
            <% else %>
              <span class="no-data">—</span>
            <% end %>
          </td>
          <td><%= row[:transaction_codes] %></td>
          <td><%= row[:phone_number] %></td>
          <td><%= row[:office] %></td>
          <td><%= row[:office_location] || '—' %></td>
          <td><%= row[:employee_id] %></td>
          <td><%= row[:post_date] %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('date-filter-form');
    const modeRange = document.getElementById('mode-range');
    const modeDay = document.getElementById('mode-day');
    const rangeFields = document.getElementById('range-mode-fields');
    const dayFields = document.getElementById('day-mode-fields');
    const fullWeekBtn = document.getElementById('full-week-btn');
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const prevDayBtn = document.getElementById('prev-day-btn');
    const nextDayBtn = document.getElementById('next-day-btn');

    // Format dates as YYYY-MM-DD
    function formatDateTime(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Format dates as YYYY-MM-DD
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Toggle between range and day mode
    function toggleMode() {
      if (modeDay.checked) {
        rangeFields.style.display = 'none';
        dayFields.style.display = 'block';
        // Disable range fields so they don't submit
        startDateInput.disabled = true;
        document.querySelectorAll('#range-mode-fields input[type="date"]').forEach(input => {
          input.disabled = true;
        });
      } else {
        rangeFields.style.display = 'block';
        dayFields.style.display = 'none';
        // Enable range fields and disable day field
        startDateInput.disabled = false;
        document.querySelectorAll('#range-mode-fields input[type="date"]').forEach(input => {
          input.disabled = false;
        });
        document.querySelectorAll('#day-mode-fields input[type="date"]').forEach(input => {
          input.disabled = true;
        });
      }
    }

    // Auto-submit form when mode changes
    modeRange.addEventListener('change', function() {
      toggleMode();
      form.submit();
    });

    modeDay.addEventListener('change', function() {
      toggleMode();
      form.submit();
    });

    // Auto-submit form when date inputs change
    const autoSubmitInputs = document.querySelectorAll('.auto-submit');
    autoSubmitInputs.forEach(function(input) {
      input.addEventListener('change', function() {
        form.submit();
      });
    });

    // Set to full week (6 days ago to today)
    fullWeekBtn.addEventListener('click', function() {
      const now = new Date();
      const sixDaysAgo = new Date(now.getTime() - (6 * 24 * 60 * 60 * 1000)); // 6 days ago

      startDateInput.value = formatDate(sixDaysAgo);
      endDateInput.value = formatDate(now);
      form.submit();
    });

    // Parse date string in local timezone (YYYY-MM-DD)
    function parseLocalDate(dateString) {
      const parts = dateString.split('-');
      return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    }

    // Update button states based on current date (for day mode)
    function updateButtonStates() {
      // Only update buttons in day mode
      if (!modeDay.checked || !endDateInput.value) return;

      const currentDate = parseLocalDate(endDateInput.value);
      const prevDate = new Date(currentDate);
      prevDate.setDate(prevDate.getDate() - 1);

      const nextDate = new Date(currentDate);
      nextDate.setDate(nextDate.getDate() + 1);

      // Check if previous day midnight would be <= 7 days ago from now
      const now = new Date();
      const sevenDaysAgo = new Date(now);
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      sevenDaysAgo.setHours(0, 0, 0, 0);

      // Check if next day would be more than tomorrow
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);

      // Disable/enable Previous Day button
      // prevDate should not be allowed if it's before 7 days ago from now
      if (prevDate.getTime() < sevenDaysAgo.getTime()) {
        prevDayBtn.disabled = true;
        prevDayBtn.style.opacity = '0.5';
        prevDayBtn.style.cursor = 'not-allowed';
      } else {
        prevDayBtn.disabled = false;
        prevDayBtn.style.opacity = '1';
        prevDayBtn.style.cursor = 'pointer';
      }

      // Disable/enable Next Day button - allow up to tomorrow
      if (nextDate > tomorrow) {
        nextDayBtn.disabled = true;
        nextDayBtn.style.opacity = '0.5';
        nextDayBtn.style.cursor = 'not-allowed';
      } else {
        nextDayBtn.disabled = false;
        nextDayBtn.style.opacity = '1';
        nextDayBtn.style.cursor = 'pointer';
      }
    }

    // Previous day button
    prevDayBtn.addEventListener('click', function() {
      if (this.disabled) return;

      const currentDate = parseLocalDate(endDateInput.value);
      const prevDate = new Date(currentDate);
      prevDate.setDate(prevDate.getDate() - 1);

      endDateInput.value = formatDate(prevDate);
      form.submit();
    });

    // Next day button
    nextDayBtn.addEventListener('click', function() {
      if (this.disabled) return;

      const currentDate = parseLocalDate(endDateInput.value);
      const nextDate = new Date(currentDate);
      nextDate.setDate(nextDate.getDate() + 1);

      endDateInput.value = formatDate(nextDate);
      form.submit();
    });

    // Update button states when date changes (in day mode)
    endDateInput.addEventListener('change', updateButtonStates);

    // Initialize on page load
    toggleMode();
    updateButtonStates();
  });
</script>

<style>
  #date-filter-form {
    margin-bottom: 2em;
  }

  #date-filter-form fieldset.box {
    padding: 1em;
  }

  #date-filter-form p {
    display: flex;
    align-items: center;
    gap: 1em;
    margin: 0.5em 0;
  }

  #date-filter-form label {
    min-width: 150px;
    font-weight: bold;
  }

  #date-filter-form .mode-options {
    display: flex;
    align-items: center;
    gap: 2em;
  }

  #date-filter-form .mode-option.floating {
    font-weight: normal;
    display: inline-flex;
    align-items: center;
    gap: 0.4em;
    white-space: nowrap;
    cursor: pointer;
    float: none !important;
    margin-left: 0 !important;
    width: auto !important;
  }

  #date-filter-form .mode-option input[type="radio"] {
    margin: 0;
  }

  #date-filter-form .date-picker {
    padding: 0.4em;
    border: 1px solid #ccc;
    border-radius: 3px;
    font-size: 0.95em;
  }

  #date-filter-form .button-small {
    margin-right: 0.5em;
  }

  #date-filter-form .info-text {
    font-size: 0.9em;
    color: #666;
    font-style: italic;
  }

  .report-info {
    margin-bottom: 1em;
    padding: 0.5em;
    background-color: #f0f0f0;
    border-left: 3px solid #169;
  }

  .nodata {
    padding: 2em;
    text-align: center;
    background-color: #f9f9f9;
    border: 1px solid #ddd;
    color: #666;
  }

  .no-data {
    color: #999;
  }

  .small {
    font-size: 0.85em;
    color: #666;
  }
</style>
